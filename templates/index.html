<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Global de Qualidade do Ar | Sistema de Monitoramento Ambiental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --un-blue: #009edb;
            --un-dark-blue: #1f4788;
            --un-light-blue: #69c5e0;
            --un-gray: #f7f7f7;
            --un-dark-gray: #4a4a4a;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --danger-red: #dc3545;
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #4a4a4a;
            --text-secondary: #6c757d;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --un-gray: #3a3a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary ) 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--un-dark-blue) 0%, var(--un-blue) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            padding: 2rem 0;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: var(--bg-secondary);
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--un-blue) 0%, var(--un-light-blue) 100%);
            color: white;
            border-radius: 16px 16px 0 0 !important;
            padding: 1.5rem;
            border: none;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .metric-card {
            text-align: center;
            padding: 2rem;
            border-radius: 16px;
            background: var(--bg-secondary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--un-blue);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--un-dark-blue);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .trend-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.2rem;
        }

        .trend-up { color: var(--danger-red); }
        .trend-down { color: var(--success-green); }
        .trend-stable { color: var(--text-secondary); }

        .table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .table {
            margin-bottom: 0;
            color: var(--text-primary);
        }

        .table thead th {
            background: var(--un-gray);
            color: var(--un-dark-blue);
            font-weight: 600;
            border: none;
            padding: 1rem;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 1rem;
            border-color: #f0f0f0;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 158, 219, 0.05);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .aqi-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.75rem;
            color: white;
        }

        .alert-item {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(220, 53, 69, 0.02) 100%);
            border: 1px solid rgba(220, 53, 69, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.1);
        }

        .alert-icon {
            color: var(--danger-red);
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .alert-title {
            font-weight: 600;
            color: var(--danger-red);
            margin-bottom: 0.5rem;
        }

        .alert-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 158, 219, 0.3);
            border-radius: 50%;
            border-top-color: var(--un-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            background: var(--un-dark-blue);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-logo {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .footer-links {
            display: flex;
            gap: 2rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: white;
        }

        .last-update {
            background: rgba(0, 158, 219, 0.1);
            color: var(--un-blue);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Filtros e an√°lise */
        .filter-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-select, .form-control, .btn {
            border-radius: 25px;
            border: 2px solid rgba(0, 158, 219, 0.2);
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--un-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 158, 219, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--un-blue) 0%, var(--un-light-blue) 100%);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 158, 219, 0.3);
        }

        .city-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .city-stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .city-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .city-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--un-dark-blue);
            margin-bottom: 1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Controles flutuantes */
        .floating-controls {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--un-blue);
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
        }

        .floating-btn.download {
            background: var(--warning-yellow);
            color: #333;
        }

        .floating-btn.theme {
            background: var(--un-dark-blue);
        }

        .floating-btn.compact {
            background: var(--success-green);
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success-green);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-red);
        }

        .notification.warning {
            background: var(--warning-yellow);
            color: #333;
        }

        /* Favoritos */
        .favorite-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .favorite-btn.active {
            color: var(--warning-yellow);
        }

        .favorite-btn:hover {
            color: var(--warning-yellow);
        }

        /* Ranking */
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .ranking-position {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--un-blue);
            margin-right: 1rem;
            min-width: 40px;
        }

        .ranking-city {
            flex-grow: 1;
            font-weight: 600;
        }

        .ranking-value {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Metas ambientais */
        .goal-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .goal-progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .goal-achieved { background: var(--success-green); }
        .goal-in-progress { background: var(--warning-yellow); }
        .goal-critical { background: var(--danger-red); }

        /* Modo compacto */
        .compact-mode .metric-card {
            padding: 1rem;
        }

        .compact-mode .metric-value {
            font-size: 1.5rem;
        }

        .compact-mode .metric-icon {
            font-size: 2rem;
        }

        .compact-mode .card {
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .metric-card {
                padding: 1.5rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-controls > * {
                width: 100%;
            }

            .floating-controls {
                bottom: 1rem;
                right: 1rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-globe-americas me-3"></i>Monitor Global de Qualidade do Ar</h1>
                    <p class="subtitle">Sistema de Monitoramento Ambiental em Tempo Real | Tecnologia Apache Spark</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Sistema Operacional</span>
                    </div>
                    <div class="last-update mt-2">
                        <i class="fas fa-clock me-1"></i>
                        √öltima atualiza√ß√£o: <span id="last-update">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <div class="container">
            <!-- Metrics Row -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="metric-card">
                        <div class="trend-indicator" id="stations-trend">
                            <i class="fas fa-minus trend-stable"></i>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="metric-value" id="total-stations">0</div>
                        <div class="metric-label">Esta√ß√µes Ativas</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card">
                        <div class="trend-indicator" id="readings-trend">
                            <i class="fas fa-arrow-up trend-up"></i>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-value" id="total-readings">0</div>
                        <div class="metric-label">Leituras Hoje</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card">
                        <div class="trend-indicator" id="alerts-trend">
                            <i class="fas fa-arrow-down trend-down"></i>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-value" id="total-alerts">0</div>
                        <div class="metric-label">Alertas Ativos</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card">
                        <div class="trend-indicator" id="quality-trend">
                            <i class="fas fa-arrow-down trend-down"></i>
                        </div>
                        <div class="metric-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="metric-value" id="air-quality-index">Bom</div>
                        <div class="metric-label">√çndice Geral</div>
                    </div>
                </div>
            </div>

            <!-- Ranking e Metas -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-trophy me-2"></i>Ranking de Cidades
                        </div>
                        <div class="card-body">
                            <h6 class="text-success mb-3"><i class="fas fa-smile me-2"></i>Melhor Qualidade do Ar</h6>
                            <div id="best-cities">
                                <div class="text-center py-3">
                                    <div class="loading-spinner me-2"></div>
                                    Carregando ranking...
                                </div>
                            </div>
                            
                            <h6 class="text-danger mb-3 mt-4"><i class="fas fa-frown me-2"></i>Necessita Aten√ß√£o</h6>
                            <div id="worst-cities">
                                <div class="text-center py-3">
                                    <div class="loading-spinner me-2"></div>
                                    Carregando ranking...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-bullseye me-2"></i>Metas Ambientais (OMS)
                        </div>
                        <div class="card-body">
                            <div id="environmental-goals">
                                <div class="text-center py-3">
                                    <div class="loading-spinner me-2"></div>
                                    Carregando metas...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-table me-2"></i>Dados de Qualidade do Ar por Esta√ß√£o
                            <span id="filter-indicator" class="badge bg-light text-dark ms-2" style="display: none;"></span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-star me-1"></i></th>
                                            <th><i class="fas fa-map-pin me-1"></i>Esta√ß√£o</th>
                                            <th><i class="fas fa-smog me-1"></i>PM2.5</th>
                                            <th><i class="fas fa-cloud me-1"></i>CO2</th>
                                            <th><i class="fas fa-wind me-1"></i>O3</th>
                                            <th><i class="fas fa-tachometer-alt me-1"></i>AQI</th>
                                            <th><i class="fas fa-chart-line me-1"></i>Tend√™ncia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="data-table">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="loading-spinner me-2"></div>
                                                Carregando dados em tempo real...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Panel -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-bell me-2"></i>Alertas de Qualidade do Ar
                        </div>
                        <div class="card-body">
                            <div id="alerts-container">
                                <div class="text-center py-3">
                                    <div class="loading-spinner me-2"></div>
                                    Carregando alertas...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Hist√≥rico -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-2"></i>Tend√™ncias das √öltimas 24 Horas
                            <small class="text-light ms-2">(Dados simulados com padr√µes realistas)</small>
                        </div>
                        <div class="card-body">
                            <canvas id="historyChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTROS E AN√ÅLISE (MOVIDO PARA BAIXO) -->
            <div class="filter-section">
                <h4 class="mb-3"><i class="fas fa-filter me-2"></i>An√°lise Avan√ßada por Cidade</h4>
                <div class="filter-controls">
                    <div class="flex-grow-1">
                        <input type="text" class="form-control" id="search-input" placeholder="üîç Buscar esta√ß√£o...">
                    </div>
                    <div class="flex-grow-1">
                        <select class="form-select" id="city-filter">
                            <option value="all">üåç Todas as Cidades</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="applyFilter()">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                </div>

                <!-- Estat√≠sticas por Cidade -->
                <div id="city-statistics" class="city-stats-grid" style="display: none;">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

            <!-- About Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-info-circle me-2"></i>Sobre o Sistema de Monitoramento
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3">Sistema de Monitoramento da Qualidade do Ar em Tempo Real</h5>
                                    <p>Este sistema foi desenvolvido como trabalho pr√°tico para a disciplina de Big Data do curso da UFRJ/CEDERJ, sob orienta√ß√£o do Prof. Alexandre de Assis Bento Lima.</p>
                                    <p>Utiliza tecnologias de ponta para processamento de dados em tempo real, demonstrando a caracter√≠stica de <strong>Velocidade</strong> do Big Data atrav√©s do Apache Spark.</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3"><i class="fas fa-cogs me-2"></i>Tecnologias Utilizadas</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Apache Spark (PySpark) para processamento em tempo real</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Python/Flask para o backend</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>HTML/CSS/JavaScript para o frontend</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Bootstrap para design responsivo</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Chart.js para visualiza√ß√µes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles Flutuantes -->
    <div class="floating-controls">
        <button class="floating-btn theme" onclick="toggleTheme()" title="Alternar Tema">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
        <button class="floating-btn compact" onclick="toggleCompactMode()" title="Modo Compacto">
            <i class="fas fa-compress-alt"></i>
        </button>
        <button class="floating-btn download" onclick="showDownloadOptions()" title="Baixar Relat√≥rio">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <i class="fas fa-globe-americas me-2"></i>
                    Monitor Global de Qualidade do Ar
                </div>
                <div class="footer-links">
                    <a href="#" onclick="showDownloadOptions()"><i class="fas fa-chart-bar me-1"></i>Relat√≥rios</a>
                    <a href="#" onclick="showDownloadOptions()"><i class="fas fa-download me-1"></i>Dados</a>
                    <a href="#"><i class="fas fa-question-circle me-1"></i>Ajuda</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFilter = 'all';
        let currentSearch = '';
        let favorites = JSON.parse(localStorage.getItem('favorites' ) || '[]');
        let historyChart = null;
        let isCompactMode = localStorage.getItem('compactMode') === 'true';

        // Sistema de notifica√ß√µes
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Toggle de tema
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'light') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
                showNotification('üåô Tema escuro ativado', 'success');
            } else {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
                showNotification('‚òÄÔ∏è Tema claro ativado', 'success');
            }
        }

        // Toggle modo compacto
        function toggleCompactMode() {
            isCompactMode = !isCompactMode;
            const body = document.body;
            
            if (isCompactMode) {
                body.classList.add('compact-mode');
                localStorage.setItem('compactMode', 'true');
                showNotification('üì± Modo compacto ativado', 'success');
            } else {
                body.classList.remove('compact-mode');
                localStorage.setItem('compactMode', 'false');
                showNotification('üñ•Ô∏è Modo normal ativado', 'success');
            }
        }

        // Carregar configura√ß√µes salvas
        function loadSavedSettings() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            body.setAttribute('data-theme', savedTheme);
            themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            if (isCompactMode) {
                body.classList.add('compact-mode');
            }
        }

        // Sistema de favoritos
        function toggleFavorite(stationId) {
            const index = favorites.indexOf(stationId);
            if (index > -1) {
                favorites.splice(index, 1);
                showNotification('‚≠ê Esta√ß√£o removida dos favoritos', 'warning');
            } else {
                favorites.push(stationId);
                showNotification('‚≠ê Esta√ß√£o adicionada aos favoritos', 'success');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            fetchLatestData(); // Recarregar para atualizar √≠cones
        }

        // Op√ß√µes de download
        function showDownloadOptions() {
            const options = ['CSV', 'JSON'];
            const choice = prompt(`üìä Escolha o formato do relat√≥rio:\n1 - CSV\n2 - JSON\n\nDigite 1 ou 2:`);
            
            if (choice === '1') {
                downloadReport('csv');
            } else if (choice === '2') {
                downloadReport('json');
            }
        }

        // Fun√ß√£o para carregar cidades no filtro
        function loadCities() {
            fetch('/api/cities')
                .then(response => response.json())
                .then(cities => {
                    const cityFilter = document.getElementById('city-filter');
                    
                    // Limpar op√ß√µes existentes (exceto "Todas as Cidades")
                    while (cityFilter.children.length > 1) {
                        cityFilter.removeChild(cityFilter.lastChild);
                    }
                    
                    // Adicionar cidades
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = `üèôÔ∏è ${city}`;
                        cityFilter.appendChild(option);
                    });
                })
                .catch(error => console.error('Erro ao carregar cidades:', error));
        }

        // Fun√ß√£o para aplicar filtro
        function applyFilter() {
            const cityFilter = document.getElementById('city-filter');
            const searchInput = document.getElementById('search-input');
            currentFilter = cityFilter.value;
            currentSearch = searchInput.value;
            
            // Atualizar indicador de filtro
            const filterIndicator = document.getElementById('filter-indicator');
            let filterText = '';
            
            if (currentFilter !== 'all') filterText += `Cidade: ${currentFilter}`;
            if (currentSearch) filterText += (filterText ? ' | ' : '') + `Busca: ${currentSearch}`;
            
            if (filterText) {
                filterIndicator.textContent = filterText;
                filterIndicator.style.display = 'inline';
            } else {
                filterIndicator.style.display = 'none';
            }
            
            // Carregar dados filtrados
            fetchFilteredData();
            loadCityStatistics();
            showNotification('üîç Filtros aplicados com sucesso', 'success');
        }

        // Fun√ß√£o para obter dados filtrados
        function fetchFilteredData() {
            let url = '/api/latest';
            const params = new URLSearchParams();
            
            if (currentFilter !== 'all') params.append('city', currentFilter);
            if (currentSearch) params.append('search', currentSearch);
            
            if (params.toString()) {
                url = `/api/data/filter?${params.toString()}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Dados filtrados recebidos:', data);
                    updateDataTable(data);
                })
                .catch(error => {
                    console.error('Erro ao buscar dados filtrados:', error);
                    showNotification('‚ùå Erro ao aplicar filtros', 'error');
                });
        }

        // Fun√ß√£o para obter os dados mais recentes
        function fetchLatestData() {
            if (currentFilter !== 'all' || currentSearch) {
                fetchFilteredData();
                return;
            }

            fetch('/api/latest')
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos:', data);
                    updateDataTable(data);
                })
                .catch(error => {
                    console.error('Erro ao buscar dados:', error);
                    document.getElementById('data-table').innerHTML = 
                        `<tr><td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-wifi me-2"></i>
                            Erro de conex√£o com o servidor
                        </td></tr>`;
                    showNotification('‚ùå Erro de conex√£o com o servidor', 'error');
                });
        }

        // Fun√ß√£o para atualizar a tabela de dados
        function updateDataTable(data) {
            if (data.error) {
                console.error('Erro na API:', data.error);
                document.getElementById('data-table').innerHTML = 
                    `<tr><td colspan="7" class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar dados: ${data.error}
                    </td></tr>`;
                return;
            }
            
            // Atualizar timestamp
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR');
            
            // Atualizar m√©tricas
            document.getElementById('total-stations').textContent = data.length;
            document.getElementById('total-readings').textContent = data.length * 3; // Simulado
            
            // Calcular √≠ndice geral
            if (data.length > 0) {
                const avgPM25 = data.reduce((sum, station) => sum + parseFloat(station.avg_PM2_5 || 0), 0) / data.length;
                let qualityIndex = 'Bom';
                if (avgPM25 > 50) qualityIndex = 'Insalubre';
                else if (avgPM25 > 35) qualityIndex = 'Moderado';
                document.getElementById('air-quality-index').textContent = qualityIndex;
            }
            
            // Limpar tabela
            const tableBody = document.getElementById('data-table');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = 
                    `<tr><td colspan="7" class="text-center py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhum dado dispon√≠vel para o filtro selecionado
                    </td></tr>`;
                return;
            }
            
            // Preencher tabela com dados
            data.forEach(station => {
                const row = document.createElement('tr');
                
                const pm25 = parseFloat(station.avg_PM2_5 || 0);
                const co2 = parseFloat(station.avg_CO2 || 0);
                const o3 = parseFloat(station.avg_O3 || 0);
                
                const stationId = station.station_id || 'N/A';
                const isFavorite = favorites.includes(stationId);
                
                // √çcone de tend√™ncia
                let trendIcon = 'fas fa-minus';
                let trendClass = 'trend-stable';
                let trendText = 'Est√°vel';
                
                if (station.trend === 'up') {
                    trendIcon = 'fas fa-arrow-up';
                    trendClass = 'trend-up';
                    trendText = `+${Math.abs(station.trend_percentage)}%`;
                } else if (station.trend === 'down') {
                    trendIcon = 'fas fa-arrow-down';
                    trendClass = 'trend-down';
                    trendText = `-${Math.abs(station.trend_percentage)}%`;
                }
                
                row.innerHTML = `
                    <td>
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${stationId}')">
                            <i class="fas fa-star"></i>
                        </button>
                    </td>
                    <td>
                        <div class="fw-bold">${station.station_name || 'N/A'}</div>
                        <small class="text-muted">${stationId} - ${station.city || 'N/A'}</small>
                    </td>
                    <td><strong>${pm25.toFixed(1)}</strong> <small>Œºg/m¬≥</small></td>
                    <td><strong>${co2.toFixed(1)}</strong> <small>ppm</small></td>
                    <td><strong>${o3.toFixed(1)}</strong> <small>Œºg/m¬≥</small></td>
                    <td>
                        <span class="aqi-badge" style="background-color: ${station.aqi.color}">
                            ${station.aqi.value}
                        </span>
                          
<small>${station.aqi.category}</small>
                    </td>
                    <td>
                        <i class="${trendIcon} ${trendClass}"></i>
                        <small class="ms-1">${trendText}</small>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Fun√ß√£o para obter alertas
        function fetchAlerts() {
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    console.log('Alertas recebidos:', alerts);
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    
                    // Atualizar contador de alertas
                    document.getElementById('total-alerts').textContent = alerts.length;
                    
                    if (alerts.length === 0) {
                        alertsContainer.innerHTML = 
                            `<div class="text-center py-3 text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Nenhum alerta ativo
                            </div>`;
                        return;
                    }
                    
                    // Limpar container
                    alertsContainer.innerHTML = '';
                    
                    // Preencher container com alertas
                    alerts.slice(0, 5).forEach(alert => { // Mostrar apenas os 5 primeiros
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert-item';
                        
                        alertDiv.innerHTML = `
                            <div class="alert-title">
                                <i class="fas fa-exclamation-triangle alert-icon"></i>
                                ${alert.station_name || 'Esta√ß√£o Desconhecida'}
                            </div>
                            <div class="alert-details">
                                N√≠veis elevados detectados:  

                                <small>
                                    PM2.5: ${parseFloat(alert.avg_PM2_5 || 0).toFixed(1)} Œºg/m¬≥ | 
                                    CO2: ${parseFloat(alert.avg_CO2 || 0).toFixed(1)} ppm | 
                                    O3: ${parseFloat(alert.avg_O3 || 0).toFixed(1)} Œºg/m¬≥
                                </small>
                            </div>
                        `;
                        
                        alertsContainer.appendChild(alertDiv);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar alertas:', error);
                    document.getElementById('alerts-container').innerHTML = 
                        `<div class="text-center py-3 text-danger">
                            <i class="fas fa-wifi me-2"></i>
                            Erro ao carregar alertas
                        </div>`;
                });
        }

        // Fun√ß√£o para carregar ranking de cidades
        function loadCityRanking() {
            fetch('/api/ranking')
                .then(response => response.json())
                .then(ranking => {
                    console.log('Ranking recebido:', ranking);
                    
                    // Melhores cidades
                    const bestContainer = document.getElementById('best-cities');
                    bestContainer.innerHTML = '';
                    
                    ranking.best.forEach((city, index) => {
                        const rankingItem = document.createElement('div');
                        rankingItem.className = 'ranking-item';
                        
                        rankingItem.innerHTML = `
                            <div class="ranking-position">${index + 1}</div>
                            <div class="ranking-city">${city.city}</div>
                            <div class="ranking-value">
                                <span class="aqi-badge" style="background-color: ${city.aqi.color}">
                                    ${city.aqi.value}
                                </span>
                            </div>
                        `;
                        
                        bestContainer.appendChild(rankingItem);
                    });
                    
                    // Piores cidades
                    const worstContainer = document.getElementById('worst-cities');
                    worstContainer.innerHTML = '';
                    
                    ranking.worst.forEach((city, index) => {
                        const rankingItem = document.createElement('div');
                        rankingItem.className = 'ranking-item';
                        
                        rankingItem.innerHTML = `
                            <div class="ranking-position">${index + 1}</div>
                            <div class="ranking-city">${city.city}</div>
                            <div class="ranking-value">
                                <span class="aqi-badge" style="background-color: ${city.aqi.color}">
                                    ${city.aqi.value}
                                </span>
                            </div>
                        `;
                        
                        worstContainer.appendChild(rankingItem);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar ranking:', error);
                });
        }

        // Fun√ß√£o para carregar metas ambientais
        function loadEnvironmentalGoals() {
            fetch('/api/environmental-goals')
                .then(response => response.json())
                .then(goals => {
                    console.log('Metas ambientais:', goals);
                    
                    const goalsContainer = document.getElementById('environmental-goals');
                    goalsContainer.innerHTML = '';
                    
                    Object.entries(goals).forEach(([pollutant, goal]) => {
                        const goalDiv = document.createElement('div');
                        goalDiv.className = 'mb-3';
                        
                        let statusClass = 'goal-in-progress';
                        if (goal.status === 'achieved') statusClass = 'goal-achieved';
                        else if (goal.status === 'critical') statusClass = 'goal-critical';
                        
                        goalDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>${pollutant.toUpperCase()}</strong>
                                <span class="text-muted">${goal.current.toFixed(1)} / ${goal.target} ${goal.unit}</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar ${statusClass}" style="width: ${goal.progress}%"></div>
                            </div>
                            <small class="text-muted">${goal.progress.toFixed(1)}% da meta OMS</small>
                        `;
                        
                        goalsContainer.appendChild(goalDiv);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar metas ambientais:', error);
                });
        }

        // Fun√ß√£o para carregar estat√≠sticas por cidade
        function loadCityStatistics() {
            fetch('/api/statistics/city')
                .then(response => response.json())
                .then(stats => {
                    console.log('Estat√≠sticas por cidade:', stats);
                    
                    const cityStatsContainer = document.getElementById('city-statistics');
                    
                    if (Object.keys(stats).length === 0) {
                        cityStatsContainer.style.display = 'none';
                        return;
                    }
                    
                    // Limpar container
                    cityStatsContainer.innerHTML = '';
                    
                    // Criar cards para cada cidade
                    Object.entries(stats).forEach(([city, data]) => {
                        const cityCard = document.createElement('div');
                        cityCard.className = 'city-stat-card';
                        
                        // √çcone de tend√™ncia da cidade
                        let trendIcon = 'fas fa-minus';
                        let trendClass = 'trend-stable';
                        let trendText = 'Est√°vel';
                        
                        if (data.trend === 'improving') {
                            trendIcon = 'fas fa-arrow-down';
                            trendClass = 'trend-down';
                            trendText = 'Melhorando';
                        } else if (data.trend === 'worsening') {
                            trendIcon = 'fas fa-arrow-up';
                            trendClass = 'trend-up';
                            trendText = 'Piorando';
                        }
                        
                        cityCard.innerHTML = `
                            <div class="city-name">
                                <i class="fas fa-city me-2"></i>${city}
                                <i class="${trendIcon} ${trendClass} ms-2" title="${trendText}"></i>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Esta√ß√µes:</span>
                                <span class="stat-value">${data.stations}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">AQI:</span>
                                <span class="aqi-badge" style="background-color: ${data.aqi.color}; font-size: 0.7rem;">
                                    ${data.aqi.value}
                                </span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">PM2.5 M√©dio:</span>
                                <span class="stat-value">${data.avg_pm25.toFixed(1)} Œºg/m¬≥</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">CO2 M√©dio:</span>
                                <span class="stat-value">${data.avg_co2.toFixed(1)} ppm</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">O3 M√©dio:</span>
                                <span class="stat-value">${data.avg_o3.toFixed(1)} Œºg/m¬≥</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Conforme OMS:</span>
                                <span class="stat-value ${data.who_compliance === 'Sim' ? 'text-success' : 'text-danger'}">
                                    ${data.who_compliance}
                                </span>
                            </div>
                        `;
                        
                        cityStatsContainer.appendChild(cityCard);
                    });
                    
                    cityStatsContainer.style.display = 'grid';
                })
                .catch(error => {
                    console.error('Erro ao carregar estat√≠sticas por cidade:', error);
                });
        }

        // Fun√ß√£o para carregar hist√≥rico e criar gr√°fico
        function loadHistory() {
            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    console.log('Hist√≥rico recebido:', data);
                    createHistoryChart(data);
                })
                .catch(error => {
                    console.error('Erro ao carregar hist√≥rico:', error);
                });
        }

        // Criar gr√°fico de hist√≥rico
        function createHistoryChart(data) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            if (historyChart) {
                historyChart.destroy();
            }
            
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.timestamp),
                    datasets: [
                        {
                            label: 'PM2.5 (Œºg/m¬≥)',
                            data: data.map(item => item.avg_pm25),
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'CO2 (ppm)',
                            data: data.map(item => item.avg_co2),
                            borderColor: '#009edb',
                            backgroundColor: 'rgba(0, 158, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'O3 (Œºg/m¬≥)',
                            data: data.map(item => item.avg_o3),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Hor√°rio'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Concentra√ß√£o'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Fun√ß√£o para baixar relat√≥rio
        function downloadReport(format = 'csv') {
            fetch(`/api/report/download?format=${format}`)
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error('Erro ao gerar relat√≥rio');
                    }
                })
                .then(blob => {
                    // Criar link para download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `relatorio_qualidade_ar_${new Date().toISOString().slice(0, 10)}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification(`üìä Relat√≥rio ${format.toUpperCase()} baixado com sucesso`, 'success');
                })
                .catch(error => {
                    console.error('Erro ao baixar relat√≥rio:', error);
                    showNotification('‚ùå Erro ao gerar relat√≥rio', 'error');
                });
        }
        
        // Fun√ß√£o de teste da API
        function testAPI() {
            fetch('/api/test')
                .then(response => response.json())
                .then(data => {
                    console.log('Teste da API:', data);
                })
                .catch(error => {
                    console.error('Erro no teste da API:', error);
                });
        }

        // Busca em tempo real
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                applyFilter();
            }, 500);
        });
        
        // Atualiza√ß√£o autom√°tica inteligente (a cada 30 segundos)
        setInterval(() => {
            fetchLatestData();
            fetchAlerts();
            
            // Atualizar ranking e metas a cada 2 minutos
            if (Math.random() < 0.5) {
                loadCityRanking();
                loadEnvironmentalGoals();
            }
        }, 30000);
        
        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedSettings();
            testAPI();
            loadCities();
            fetchLatestData();
            fetchAlerts();
            loadCityStatistics();
            loadHistory();
            loadCityRanking();
            loadEnvironmentalGoals();
            
            showNotification('üöÄ Sistema carregado com sucesso!', 'success');
        });
    </script>
</body>
</html>
